<label for="mySlider">Sea level: <span id="sliderValue"></span></label>
<br>
<input type="range" id="mySlider" min="0" max="2500" step="1" value="0" style="width:300px;">
<div id="map" style="height: 800px; width: 1200px"></div>

<script src="https://cdn.jsdelivr.net/npm/gridviz@3.0.26"></script>
<script src="https://cdn.jsdelivr.net/npm/gridviz-eurostat@2.1.1"></script>
<script src="https://cdn.jsdelivr.net/npm/gridviz-parquet@1.1.1"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-array@3.2.4"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>
<script>

    const seaColor = "#a4c8e1"

    const map = new gridviz.Map(document.getElementById('map'), {
        x: 4400000, y: 2400000, z: 300,
        backgroundColor: seaColor
    }).addZoomButtons()

    const datasetRelief = new gridviz.MultiResolutionDataset(
        [100, 200, 500, 1000, 2000, 5000, 10000, 20000],
        resolution => new gviz_par.TiledParquetGrid(map,
            "https://raw.githubusercontent.com/jgaffuri/tiled-euroDEM/main/pub/v1/tiles_" + resolution + "/"),
        { preprocess: (c) => c.v != undefined && c.v > 0 }
    )

    //TODO use 100m https://github.com/jgaffuri/europop100m/tree/main/pub/tiles_parquet/100
    const datasetPop = new gridviz.MultiResolutionDataset(
        [1000, 2000, 5000, 10000, 20000, 50000, 100000],
        resolution => new gviz_par.TiledParquetGrid(map,
            "https://raw.githubusercontent.com/jgaffuri/tiled-popgrid/main/pub/v1/2021/" + resolution + "/"),
        { preprocess: (c) => c.p>0 }
    )

    const datasetCLC = new gridviz.MultiResolutionDataset(
        [100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000],
        resolution => new gviz_par.TiledParquetGrid(map,
            "https://raw.githubusercontent.com/jgaffuri/tiledgrids/main/data/europe/clc_/" + resolution + "m/"),
        { preprocess: (c) => c.v != undefined && c.v > 0 }
    )

    
    //define style
    const colors = [
        "#004529",
        "#006837",
        "#238443",
        "#41AB5D",
        "#78C679",
        "#ADDD8E",
        "#FEE08B",
        "#FDAE61",
        "#F46D43",
        "#D73027",
        "#A50026",
        //"#FFFFFF"
    ];
    const classNumber = colors.length
    const styleRelief = new gridviz.ShapeColorSizeStyle({
        viewScale: cells => d3.extent(cells, c => +c.v),
        color: (c, r, z, vs) => {
            //const min = Math.max(vs[0], seaLevel)
            const min = vs[0]
            let t = (c.v - min) / (vs[1] - min)
            t = Math.pow(t, 0.5)
            //let t = c.v / 3000
            t = Math.floor(t * classNumber)
            if (t > 11) t = 11
            return colors[t]
        }
    })

    const stylePopulation = new gridviz.ShapeColorSizeStyle({
        viewScale: cells => d3.max(cells, c => +c.p),
        shape: () => "circle",
        size: (c, r, z, max) => {
            let t = c.p / max
            t = Math.pow(t, 0.4)
            return r * t * 1.3
        },
        color: () => "#333",
    })


    let seaLevel = 0
    const styleWater = new gridviz.ShapeColorSizeStyle({
        color: (c, r, z, vs) => {
            if (c.v > seaLevel) return
            return seaColor + "aa"
        }
    })

    const labelLayer = new gridviz.LabelLayer(
        gridviz_eurostat.getEuronymeLabelLayer('EUR', 20)
    )

    map.layers = [
        // relief
        new gridviz.GridLayer(datasetRelief, [styleRelief], { minPixelsPerCell: 1.5 }),
        // population
        new gridviz.GridLayer(datasetPop, [stylePopulation], { minPixelsPerCell: 3 }),
        // sea level
        new gridviz.GridLayer(datasetRelief, [styleWater], { minPixelsPerCell: 1.5 }),
        labelLayer
    ]

    const slider = document.getElementById('mySlider');
    const label = document.getElementById('sliderValue');

    function updateSlider() {
        seaLevel = +slider.value;
        label.textContent = slider.value + ' m';
        map.redraw()
    }

    slider.addEventListener('input', updateSlider);
    updateSlider();

</script>
